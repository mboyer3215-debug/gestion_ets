{% extends "base.html" %}

{% block title %}{% if prestation %}Modifier{% else %}Nouvelle{% endif %} prestation{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="bi bi-{% if prestation %}pencil{% else %}plus-circle{% endif %}"></i>
        {% if prestation %}Modifier{% else %}Nouvelle{% endif %} prestation
    </h1>
    <div>
        <a href="/" class="btn btn-outline-secondary me-2">
            <i class="bi bi-house"></i> Accueil
        </a>
        <a href="/prestations" class="btn btn-outline-secondary">
            <i class="bi bi-list"></i> Liste
        </a>
    </div>
</div>

<form method="POST" enctype="multipart/form-data">
    
    <!-- CLIENT -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <i class="bi bi-person"></i> Client
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3 position-relative">
                    <label class="form-label fw-bold">Client <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="client_search" autocomplete="off"
                           placeholder="Rechercher un client..."
                           value="{% if prestation and prestation.client %}{{ prestation.client.nom }}{% if prestation.client.prenom %} {{ prestation.client.prenom }}{% endif %}{% endif %}">
                    <div id="client_suggestions" class="list-group position-absolute w-100" style="z-index:1050; display:none;"></div>
                    <input type="hidden" id="client_id" name="client_id" value="{{ prestation.client_id if prestation else '' }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Date de la demande</label>
                    <input type="date" class="form-control" name="date_demande"
                           value="{{ prestation.date_demande.strftime('%Y-%m-%d') if prestation and prestation.date_demande else '' }}">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Référence commande</label>
                    <input type="text" class="form-control" name="reference_commande"
                           value="{{ prestation.reference_commande if prestation else '' }}"
                           placeholder="CMD-2025-001">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Demandeur</label>
                    <input type="text" class="form-control" name="demandeur"
                           value="{{ prestation.demandeur if prestation else '' }}"
                           placeholder="Si différent du client">
                </div>
            </div>
        </div>
    </div>

    <!-- THÈME / DOMAINE / TYPE -->
    <div class="card mb-3">
        <div class="card-header bg-success text-white">
            <i class="bi bi-tags"></i> Thème, Domaine et Type
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Thème <span class="text-danger">*</span></label>
                    <select class="form-select" id="theme_prestation" name="theme_prestation" required>
                        <option value="">-- Sélectionnez --</option>
                        <option value="Formation" {% if prestation and prestation.theme_prestation == 'Formation' %}selected{% endif %}>Formation</option>
                        <option value="Service" {% if prestation and prestation.theme_prestation == 'Service' %}selected{% endif %}>Service</option>
                        <option value="Audit" {% if prestation and prestation.theme_prestation == 'Audit' %}selected{% endif %}>Audit</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Domaine</label>
                    <select class="form-select" id="domaine_prestation" name="domaine_prestation">
                        <option value="">-- Sélectionnez --</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Type</label>
                    <select class="form-select" id="type_prestation" name="type_prestation">
                        <option value="">-- Sélectionnez --</option>
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Description</label>
                <textarea class="form-control" name="description" rows="2">{{ prestation.description if prestation else '' }}</textarea>
            </div>
        </div>
    </div>

    <!-- DATES ET SESSIONS -->
    <div class="card mb-3">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <span><i class="bi bi-calendar"></i> Dates et Sessions</span>
            <button type="button" class="btn btn-sm btn-light" id="btn-ajouter-session">
                <i class="bi bi-plus"></i> Ajouter session
            </button>
        </div>
        <div class="card-body">
            <div id="sessions-container"></div>
            
            <template id="session-template">
                <div class="session-item card mb-3 border-secondary">
                    <div class="card-header bg-light d-flex justify-content-between">
                        <strong>Session <span class="session-numero">1</span></strong>
                        <button type="button" class="btn btn-sm btn-danger btn-supprimer-session">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Date début <span class="text-danger">*</span></label>
                                <input type="date" class="form-control session-date-debut" name="sessions_date_debut[]" required>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Date fin</label>
                                <input type="date" class="form-control session-date-fin" name="sessions_date_fin[]">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <label class="form-label">Créneau</label>
                                <select class="form-select session-creneau" name="sessions_creneau[]">
                                    <option value="">-- Sélectionnez --</option>
                                    <option value="Matin">Matin (8h-12h)</option>
                                    <option value="Après-midi">Après-midi (13h-17h)</option>
                                    <option value="Journée">Journée (8h-18h)</option>
                                    <option value="Personnalisé">Personnalisé</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label">Durée (h)</label>
                                <input type="number" step="0.5" class="form-control session-duree" name="sessions_duree[]">
                            </div>
                            <div class="col-md-4 mb-2 horaires-personnalises" style="display:none;">
                                <label class="form-label">Horaires</label>
                                <div class="d-flex gap-1">
                                    <input type="time" class="form-control session-heure-debut" name="sessions_heure_debut[]" value="08:00">
                                    <input type="time" class="form-control session-heure-fin" name="sessions_heure_fin[]" value="18:00">
                                </div>
                            </div>
                        </div>
                        <input type="hidden" class="session-journee-complete" name="sessions_journee_complete[]" value="">
                        <input type="hidden" class="session-id" name="sessions_id[]" value="">
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- LIEU -->
    <div class="card mb-3">
        <div class="card-header bg-warning text-dark">
            <i class="bi bi-geo-alt"></i> Lieu
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label fw-bold">Nom du lieu</label>
                <input type="text" class="form-control" name="lieu"
                       value="{{ prestation.lieu if prestation else '' }}"
                       placeholder="Ex: Carrefour Toulouse">
            </div>
            <div class="mb-3 position-relative">
                <label class="form-label fw-bold">Adresse complète</label>
                <input type="text" class="form-control" id="adresse_prestation_search" autocomplete="off"
                       placeholder="Ex: 10 Rue de la Paix, 75002 Paris"
                       value="{{ prestation.adresse_prestation if prestation else '' }}">
                <div id="adresse_suggestions" class="list-group position-absolute w-100" style="z-index:1000; display:none;"></div>
                <input type="hidden" id="adresse_prestation" name="adresse_prestation" value="{{ prestation.adresse_prestation if prestation else '' }}">
                <input type="hidden" id="code_postal_prestation" name="code_postal_prestation" value="{{ prestation.code_postal_prestation if prestation else '' }}">
                <input type="hidden" id="ville_prestation" name="ville_prestation" value="{{ prestation.ville_prestation if prestation else '' }}">
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Distance (km)</label>
                    <input type="number" step="0.1" class="form-control" id="distance_km" name="distance_km"
                           value="{{ prestation.distance_km if prestation else '' }}" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Durée trajet (min)</label>
                    <input type="number" class="form-control" id="duree_trajet_minutes" name="duree_trajet_minutes"
                           value="{{ prestation.duree_trajet_minutes if prestation else '' }}" readonly>
                </div>
            </div>
        </div>
    </div>

    <!-- PARTICIPANTS -->
    <div class="card mb-3">
        <div class="card-header bg-secondary text-white">
            <i class="bi bi-people"></i> Participants
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-2">
                    <label class="form-label">Nb stagiaires</label>
                    <input type="number" class="form-control" name="nb_stagiaires" value="{{ prestation.nb_stagiaires if prestation else '' }}" min="0">
                </div>
                <div class="col-md-4 mb-2">
                    <label class="form-label">Nb repas</label>
                    <input type="number" class="form-control" name="nb_repas" value="{{ prestation.nb_repas if prestation else '' }}" min="0">
                </div>
                <div class="col-md-4 mb-2">
                    <label class="form-label">Nb hébergements</label>
                    <input type="number" class="form-control" name="nb_hebergements" value="{{ prestation.nb_hebergements if prestation else '' }}" min="0">
                </div>
            </div>
        </div>
    </div>

    <!-- TARIFICATION -->
    <div class="card mb-3">
        <div class="card-header bg-success text-white">
            <i class="bi bi-currency-euro"></i> Tarification
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-2">
                    <label class="form-label">Tarif horaire (€)</label>
                    <input type="number" step="0.01" class="form-control" name="tarif_horaire"
                           value="{{ prestation.tarif_horaire if prestation else '' }}">
                </div>
                <div class="col-md-6 mb-2">
                    <label class="form-label">Tarif total (€)</label>
                    <input type="number" step="0.01" class="form-control" name="tarif_total"
                           value="{{ prestation.tarif_total if prestation else '' }}">
                </div>
            </div>
        </div>
    </div>

    <!-- BOUTONS -->
    <div class="d-flex gap-2">
        <a href="/prestations" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Annuler
        </a>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> Enregistrer
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// DONNÉES SERVEUR
window.PRESTATION_SESSIONS_DATA = [
    {% if prestation and prestation.sessions %}
        {% for session in prestation.sessions %}
            {
                id: {{ session.id }},
                date_debut: '{{ session.date_debut.isoformat() if session.date_debut else "" }}',
                date_fin: '{{ session.date_fin.isoformat() if session.date_fin else "" }}',
                duree_heures: {{ session.duree_heures if session.duree_heures else 'null' }}
            }{% if not loop.last %},{% endif %}
        {% endfor %}
    {% endif %}
];

const prestationsStructure = {
    'Formation': {
        'Secourisme': ['FI SST', 'MAC SST'],
        'Incendie': ['EPI', 'Extincteur', 'SSIAP 1'],
        'Prévention': ['Gestes et Postures']
    },
    'Service': {
        'Prévention ERP': ['Dossier sécurité', 'Notice accessibilité']
    },
    'Audit': {
        'Risque professionnel': ['DUERP'],
        'Risque incendie': ['RCCI']
    }
};

document.addEventListener('DOMContentLoaded', function() {
    // SESSIONS
    const sessionsContainer = document.getElementById('sessions-container');
    const sessionTemplate = document.getElementById('session-template');
    let sessionCounter = 0;

    function ajouterSession(data = null) {
        sessionCounter++;
        const clone = sessionTemplate.content.cloneNode(true);
        const sessionItem = clone.querySelector('.session-item');
        
        clone.querySelector('.session-numero').textContent = sessionCounter;
        
        if (data) {
            clone.querySelector('.session-date-debut').value = data.date_debut ? data.date_debut.split('T')[0] : '';
            clone.querySelector('.session-date-fin').value = data.date_fin ? data.date_fin.split('T')[0] : '';
            clone.querySelector('.session-duree').value = data.duree_heures || '';
            clone.querySelector('.session-id').value = data.id || '';
        }
        
        sessionsContainer.appendChild(clone);
        bindSessionEvents(sessionsContainer.lastElementChild);
    }

    function bindSessionEvents(sessionEl) {
        const creneauSelect = sessionEl.querySelector('.session-creneau');
        const horairesDiv = sessionEl.querySelector('.horaires-personnalises');
        const btnSupprimer = sessionEl.querySelector('.btn-supprimer-session');
        
        creneauSelect.addEventListener('change', function() {
            horairesDiv.style.display = this.value === 'Personnalisé' ? 'block' : 'none';
        });
        
        btnSupprimer.addEventListener('click', function() {
            if (sessionsContainer.querySelectorAll('.session-item').length > 1) {
                sessionEl.remove();
            } else {
                alert('Au moins une session requise');
            }
        });
    }

    document.getElementById('btn-ajouter-session').addEventListener('click', () => ajouterSession());

    // Init sessions
    const sessionsData = window.PRESTATION_SESSIONS_DATA || [];
    if (sessionsData.length > 0) {
        sessionsData.forEach(s => ajouterSession(s));
    } else {
        ajouterSession();
    }

    // THÈME/DOMAINE/TYPE
    const themeSelect = document.getElementById('theme_prestation');
    const domaineSelect = document.getElementById('domaine_prestation');
    const typeSelect = document.getElementById('type_prestation');

    themeSelect.addEventListener('change', function() {
        domaineSelect.innerHTML = '<option value="">-- Sélectionnez --</option>';
        typeSelect.innerHTML = '<option value="">-- Sélectionnez --</option>';
        
        if (this.value && prestationsStructure[this.value]) {
            Object.keys(prestationsStructure[this.value]).forEach(domaine => {
                const opt = document.createElement('option');
                opt.value = domaine;
                opt.textContent = domaine;
                domaineSelect.appendChild(opt);
            });
        }
    });

    domaineSelect.addEventListener('change', function() {
        typeSelect.innerHTML = '<option value="">-- Sélectionnez --</option>';
        
        const theme = themeSelect.value;
        if (theme && this.value && prestationsStructure[theme][this.value]) {
            prestationsStructure[theme][this.value].forEach(type => {
                const opt = document.createElement('option');
                opt.value = type;
                opt.textContent = type;
                typeSelect.appendChild(opt);
            });
        }
    });

    // RECHERCHE CLIENT
    const clientSearch = document.getElementById('client_search');
    const clientSuggestions = document.getElementById('client_suggestions');
    const clientIdHidden = document.getElementById('client_id');
    let debounce;

    clientSearch.addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length < 2) {
            clientSuggestions.style.display = 'none';
            return;
        }
        
        clearTimeout(debounce);
        debounce = setTimeout(async () => {
            const res = await fetch(`/api/rechercher-clients?q=${encodeURIComponent(query)}`);
            const data = await res.json();
            
            if (data.success && data.clients.length > 0) {
                clientSuggestions.innerHTML = '';
                data.clients.forEach(client => {
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'list-group-item list-group-item-action';
                    item.textContent = client.display;
                    item.onclick = () => {
                        clientSearch.value = client.display;
                        clientIdHidden.value = client.id;
                        clientSuggestions.style.display = 'none';
                    };
                    clientSuggestions.appendChild(item);
                });
                clientSuggestions.style.display = 'block';
            }
        }, 300);
    });

    // ADRESSE
    const adresseSearch = document.getElementById('adresse_prestation_search');
    const adresseSuggestions = document.getElementById('adresse_suggestions');
    
    adresseSearch.addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length < 3) {
            adresseSuggestions.style.display = 'none';
            return;
        }
        
        clearTimeout(debounce);
        debounce = setTimeout(async () => {
            const url = `https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=10`;
            const res = await fetch(url);
            const data = await res.json();
            
            if (data.features.length > 0) {
                adresseSuggestions.innerHTML = '';
                data.features.forEach(feature => {
                    const props = feature.properties;
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'list-group-item list-group-item-action';
                    item.innerHTML = `<strong>${props.name}</strong><br><small>${props.postcode} ${props.city}</small>`;
                    item.onclick = () => {
                        adresseSearch.value = `${props.name}, ${props.postcode} ${props.city}`;
                        document.getElementById('adresse_prestation').value = props.name;
                        document.getElementById('code_postal_prestation').value = props.postcode;
                        document.getElementById('ville_prestation').value = props.city;
                        adresseSuggestions.style.display = 'none';
                    };
                    adresseSuggestions.appendChild(item);
                });
                adresseSuggestions.style.display = 'block';
            }
        }, 300);
    });
});
</script>
{% endblock %}
