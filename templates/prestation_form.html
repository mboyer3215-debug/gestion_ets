{% extends "base.html" %}

{% block title %}{% if prestation %}Modifier{% else %}Nouvelle{% endif %} prestation{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="bi bi-{% if prestation %}pencil{% else %}plus-circle{% endif %}"></i>
        {% if prestation %}Modifier{% else %}Nouvelle{% endif %} prestation
    </h1>
    <div>
        <a href="/" class="btn btn-outline-secondary me-2">
            <i class="bi bi-house"></i> Accueil
        </a>
        <a href="/prestations" class="btn btn-outline-secondary">
            <i class="bi bi-list"></i> Liste
        </a>
    </div>
</div>

<form method="POST" enctype="multipart/form-data">
    
    <!-- CLIENT -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <i class="bi bi-person"></i> Client
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3 position-relative">
                    <label class="form-label fw-bold">Client <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="client_search" autocomplete="off"
                           placeholder="Rechercher un client..."
                           value="{% if prestation and prestation.client %}{{ prestation.client.nom }}{% if prestation.client.prenom %} {{ prestation.client.prenom }}{% endif %}{% endif %}">
                    <div id="client_suggestions" class="list-group position-absolute w-100" style="z-index:1050; display:none; max-height:300px; overflow-y:auto;"></div>
                    <input type="hidden" id="client_id" name="client_id" value="{{ prestation.client_id if prestation else '' }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Date de la demande</label>
                    <input type="date" class="form-control" name="date_demande"
                           value="{{ prestation.date_demande.strftime('%Y-%m-%d') if prestation and prestation.date_demande else '' }}">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Référence commande</label>
                    <input type="text" class="form-control" name="reference_commande"
                           value="{{ prestation.reference_commande if prestation else '' }}"
                           placeholder="CMD-2025-001">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Demandeur</label>
                    <input type="text" class="form-control" name="demandeur"
                           value="{{ prestation.demandeur if prestation else '' }}"
                           placeholder="Si différent du client">
                </div>
            </div>
        </div>
    </div>

    <!-- THÈME / DOMAINE / TYPE -->
    <div class="card mb-3">
        <div class="card-header bg-success text-white">
            <i class="bi bi-tags"></i> Thème, Domaine et Type
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Thème <span class="text-danger">*</span></label>
                    <select class="form-select" id="theme_prestation" name="theme_prestation" required>
                        <option value="">-- Sélectionnez --</option>
                        <option value="Formation" {% if prestation and prestation.theme_prestation == 'Formation' %}selected{% endif %}>Formation</option>
                        <option value="Service" {% if prestation and prestation.theme_prestation == 'Service' %}selected{% endif %}>Service</option>
                        <option value="Audit" {% if prestation and prestation.theme_prestation == 'Audit' %}selected{% endif %}>Audit</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Domaine</label>
                    <select class="form-select" id="domaine_prestation" name="domaine_prestation">
                        <option value="">-- Sélectionnez --</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Type</label>
                    <select class="form-select" id="type_prestation" name="type_prestation">
                        <option value="">-- Sélectionnez --</option>
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Description</label>
                <textarea class="form-control" name="description" rows="2">{{ prestation.description if prestation else '' }}</textarea>
            </div>
        </div>
    </div>

    <!-- DATES ET SESSIONS -->
    <div class="card mb-3">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <span><i class="bi bi-calendar"></i> Dates et Sessions</span>
            <button type="button" class="btn btn-sm btn-light" id="btn-ajouter-session">
                <i class="bi bi-plus"></i> Ajouter session
            </button>
        </div>
        <div class="card-body">
            <div id="sessions-container"></div>
            
            <template id="session-template">
                <div class="session-item card mb-3 border-secondary">
                    <div class="card-header bg-light d-flex justify-content-between">
                        <strong>Session <span class="session-numero">1</span></strong>
                        <button type="button" class="btn btn-sm btn-danger btn-supprimer-session">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Date début <span class="text-danger">*</span></label>
                                <input type="date" class="form-control session-date-debut" name="sessions_date_debut[]" required>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Date fin</label>
                                <input type="date" class="form-control session-date-fin" name="sessions_date_fin[]">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <label class="form-label">Créneau</label>
                                <select class="form-select session-creneau" name="sessions_creneau[]">
                                    <option value="">-- Sélectionnez --</option>
                                    <option value="Matin">Matin (8h-12h)</option>
                                    <option value="Après-midi">Après-midi (13h-17h)</option>
                                    <option value="Journée">Journée (8h-18h)</option>
                                    <option value="Personnalisé">Personnalisé</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label">Durée (h)</label>
                                <input type="number" step="0.5" class="form-control session-duree" name="sessions_duree[]">
                            </div>
                            <div class="col-md-4 mb-2 horaires-personnalises" style="display:none;">
                                <label class="form-label">Horaires</label>
                                <div class="d-flex gap-1">
                                    <input type="time" class="form-control form-control-sm session-heure-debut" name="sessions_heure_debut[]" value="08:00">
                                    <input type="time" class="form-control form-control-sm session-heure-fin" name="sessions_heure_fin[]" value="18:00">
                                </div>
                            </div>
                        </div>
                        <input type="hidden" class="session-journee-complete" name="sessions_journee_complete[]" value="">
                        <input type="hidden" class="session-id" name="sessions_id[]" value="">
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- LIEU -->
    <div class="card mb-3">
        <div class="card-header bg-warning text-dark">
            <i class="bi bi-geo-alt"></i> Lieu
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label fw-bold">Nom du lieu</label>
                <input type="text" class="form-control" name="lieu"
                       value="{{ prestation.lieu if prestation else '' }}"
                       placeholder="Ex: Carrefour Toulouse">
            </div>
            <div class="mb-3 position-relative">
                <label class="form-label fw-bold">Adresse complète</label>
                <input type="text" class="form-control" id="adresse_prestation_search" autocomplete="off"
                       placeholder="Ex: 10 Rue de la Paix, 75002 Paris"
                       value="{% if prestation %}{{ prestation.adresse_prestation }}{% if prestation.code_postal_prestation %}, {{ prestation.code_postal_prestation }}{% endif %}{% if prestation.ville_prestation %} {{ prestation.ville_prestation }}{% endif %}{% endif %}">
                <div id="adresse_suggestions" class="list-group position-absolute w-100" style="z-index:1000; display:none; max-height:300px; overflow-y:auto;"></div>
                <input type="hidden" id="adresse_prestation" name="adresse_prestation" value="{{ prestation.adresse_prestation if prestation else '' }}">
                <input type="hidden" id="code_postal_prestation" name="code_postal_prestation" value="{{ prestation.code_postal_prestation if prestation else '' }}">
                <input type="hidden" id="ville_prestation" name="ville_prestation" value="{{ prestation.ville_prestation if prestation else '' }}">
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Distance (km)</label>
                    <input type="number" step="0.1" class="form-control" id="distance_km" name="distance_km"
                           value="{{ prestation.distance_km if prestation else '' }}" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Durée trajet (min)</label>
                    <input type="number" class="form-control" id="duree_trajet_minutes" name="duree_trajet_minutes"
                           value="{{ prestation.duree_trajet_minutes if prestation else '' }}" readonly>
                </div>
            </div>
        </div>
    </div>

    <!-- PARTICIPANTS -->
    <div class="card mb-3">
        <div class="card-header bg-secondary text-white">
            <i class="bi bi-people"></i> Participants
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-2">
                    <label class="form-label">Nb stagiaires</label>
                    <input type="number" class="form-control" name="nb_stagiaires" value="{{ prestation.nb_stagiaires if prestation else '' }}" min="0">
                </div>
                <div class="col-md-4 mb-2">
                    <label class="form-label">Nb repas</label>
                    <input type="number" class="form-control" name="nb_repas" value="{{ prestation.nb_repas if prestation else '' }}" min="0">
                </div>
                <div class="col-md-4 mb-2">
                    <label class="form-label">Nb hébergements</label>
                    <input type="number" class="form-control" name="nb_hebergements" value="{{ prestation.nb_hebergements if prestation else '' }}" min="0">
                </div>
            </div>
        </div>
    </div>

    <!-- TARIFICATION DÉTAILLÉE -->
    <div class="card mb-3">
        <div class="card-header bg-success text-white">
            <i class="bi bi-currency-euro"></i> Tarification détaillée
        </div>
        <div class="card-body">
            <!-- Tarifs simples -->
            <div class="row mb-3">
                <div class="col-md-6 mb-2">
                    <label class="form-label">Tarif horaire (€)</label>
                    <input type="number" step="0.01" class="form-control" name="tarif_horaire"
                           value="{{ prestation.tarif_horaire if prestation else '' }}">
                </div>
                <div class="col-md-6 mb-2">
                    <label class="form-label">Tarif total (€)</label>
                    <input type="number" step="0.01" class="form-control" id="tarif_total" name="tarif_total"
                           value="{{ prestation.tarif_total if prestation else '' }}">
                </div>
            </div>

            <hr>
            <h6 class="mb-3"><i class="bi bi-table"></i> Détail des tarifs</h6>

            <div id="tarifs-container"></div>

            <button type="button" class="btn btn-sm btn-outline-secondary mb-3" onclick="ajouterLigneTarif()">
                <i class="bi bi-plus-circle"></i> Ajouter une ligne
            </button>

            <!-- Totaux -->
            <div class="p-3 bg-light rounded">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Total HT :</strong> <span id="total-ht">0.00 €</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Total TVA :</strong> <span id="total-tva">0.00 €</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Total TTC :</strong> <span id="total-ttc">0.00 €</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TÂCHES -->
    <div class="card mb-3">
        <div class="card-header bg-danger text-white">
            <i class="bi bi-check2-square"></i> Tâche associée (optionnel)
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label fw-bold">Titre de la tâche</label>
                <input type="text" class="form-control" name="titre_tache"
                       value="{{ prestation.titre_tache if prestation else '' }}"
                       placeholder="Ex: Préparer les supports de formation">
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Description de la tâche</label>
                <textarea class="form-control" name="description_tache" rows="2"
                          placeholder="Détails de ce qui doit être fait">{{ prestation.description_tache if prestation else '' }}</textarea>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Date de début</label>
                    <input type="datetime-local" class="form-control" name="date_debut_tache"
                           value="{{ prestation.date_debut_tache.strftime('%Y-%m-%dT%H:%M') if prestation and prestation.date_debut_tache else '' }}">
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Date d'échéance</label>
                    <input type="datetime-local" class="form-control" name="date_echeance_tache"
                           value="{{ prestation.date_echeance_tache.strftime('%Y-%m-%dT%H:%M') if prestation and prestation.date_echeance_tache else '' }}">
                    <small class="text-muted">Les tâches avec échéance proche apparaissent sur le tableau de bord</small>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Priorité</label>
                    <select class="form-select" name="priorite_tache">
                        <option value="Basse" {% if prestation and prestation.priorite_tache == 'Basse' %}selected{% endif %}>Basse</option>
                        <option value="Moyenne" {% if not prestation or prestation.priorite_tache == 'Moyenne' %}selected{% endif %}>Moyenne</option>
                        <option value="Haute" {% if prestation and prestation.priorite_tache == 'Haute' %}selected{% endif %}>Haute</option>
                    </select>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Statut</label>
                    <select class="form-select" name="statut_tache">
                        <option value="À faire" {% if not prestation or prestation.statut_tache == 'À faire' %}selected{% endif %}>À faire</option>
                        <option value="En cours" {% if prestation and prestation.statut_tache == 'En cours' %}selected{% endif %}>En cours</option>
                        <option value="Terminée" {% if prestation and prestation.statut_tache == 'Terminée' %}selected{% endif %}>Terminée</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- BOUTONS -->
    <div class="d-flex gap-2">
        <a href="/prestations" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Annuler
        </a>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> Enregistrer
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// DONNÉES SERVEUR
window.PRESTATION_SESSIONS_DATA = [
    {% if prestation and prestation.sessions %}
        {% for session in prestation.sessions %}
            {
                id: {{ session.id }},
                date_debut: '{{ session.date_debut.isoformat() if session.date_debut else "" }}',
                date_fin: '{{ session.date_fin.isoformat() if session.date_fin else "" }}',
                duree_heures: {{ session.duree_heures if session.duree_heures else 'null' }},
                journee_complete: {{ 'true' if session.journee_complete else 'false' }}
            }{% if not loop.last %},{% endif %}
        {% endfor %}
    {% endif %}
];

const prestationsStructure = {
    'Formation': {
        'Secourisme': ['FI SST', 'MAC SST', 'Gestes de Premiers Secours'],
        'Incendie': ['EPI', 'Extincteur', 'Evacuation', 'SSIAP 1', 'SSIAP 2'],
        'Prévention': ['Gestes et Postures', 'TMS', 'PRAP']
    },
    'Service': {
        'Prévention ERP': ['Dossier sécurité', 'Notice accessibilité', 'Notice de sécurité']
    },
    'Audit': {
        'Risque professionnel': ['DUERP', 'Evaluation des risques'],
        'Risque incendie': ['RCCI', 'Audit incendie']
    }
};

document.addEventListener('DOMContentLoaded', function() {
    
    // ============================================================================
    // GESTION DES SESSIONS
    // ============================================================================
    const sessionsContainer = document.getElementById('sessions-container');
    const sessionTemplate = document.getElementById('session-template');
    let sessionCounter = 0;

    function ajouterSession(data = null) {
        sessionCounter++;
        const clone = sessionTemplate.content.cloneNode(true);
        
        clone.querySelector('.session-numero').textContent = sessionCounter;
        
        if (data) {
            clone.querySelector('.session-date-debut').value = data.date_debut ? data.date_debut.split('T')[0] : '';
            clone.querySelector('.session-date-fin').value = data.date_fin ? data.date_fin.split('T')[0] : '';
            clone.querySelector('.session-duree').value = data.duree_heures || '';
            clone.querySelector('.session-id').value = data.id || '';
            
            const heureDebut = data.date_debut ? data.date_debut.split('T')[1]?.substring(0, 5) || '08:00' : '08:00';
            const heureFin = data.date_fin ? data.date_fin.split('T')[1]?.substring(0, 5) || '18:00' : '18:00';
            clone.querySelector('.session-heure-debut').value = heureDebut;
            clone.querySelector('.session-heure-fin').value = heureFin;
            
            if (data.journee_complete) {
                clone.querySelector('.session-creneau').value = 'Journée';
                clone.querySelector('.session-journee-complete').value = '1';
            }
        }
        
        sessionsContainer.appendChild(clone);
        bindSessionEvents(sessionsContainer.lastElementChild);
    }

    function bindSessionEvents(sessionEl) {
        const creneauSelect = sessionEl.querySelector('.session-creneau');
        const horairesDiv = sessionEl.querySelector('.horaires-personnalises');
        const journeeCompleteInput = sessionEl.querySelector('.session-journee-complete');
        const btnSupprimer = sessionEl.querySelector('.btn-supprimer-session');
        
        creneauSelect.addEventListener('change', function() {
            if (this.value === 'Personnalisé') {
                horairesDiv.style.display = 'block';
                journeeCompleteInput.value = '';
            } else {
                horairesDiv.style.display = 'none';
                if (this.value === 'Journée') {
                    journeeCompleteInput.value = '1';
                } else {
                    journeeCompleteInput.value = '';
                }
            }
        });
        
        btnSupprimer.addEventListener('click', function() {
            if (sessionsContainer.querySelectorAll('.session-item').length > 1) {
                sessionEl.remove();
            } else {
                alert('Au moins une session requise');
            }
        });
        
        // Init affichage horaires
        if (creneauSelect.value === 'Personnalisé') {
            horairesDiv.style.display = 'block';
        }
    }

    document.getElementById('btn-ajouter-session').addEventListener('click', () => ajouterSession());

    // Init sessions
    const sessionsData = window.PRESTATION_SESSIONS_DATA || [];
    if (sessionsData.length > 0) {
        sessionsData.forEach(s => ajouterSession(s));
    } else {
        ajouterSession();
    }

    // ============================================================================
    // THÈME/DOMAINE/TYPE
    // ============================================================================
    const themeSelect = document.getElementById('theme_prestation');
    const domaineSelect = document.getElementById('domaine_prestation');
    const typeSelect = document.getElementById('type_prestation');
    
    const initialTheme = themeSelect.value;
    const initialDomaine = '{{ prestation.domaine_prestation if prestation else "" }}';
    const initialType = '{{ prestation.type_prestation if prestation else "" }}';

    themeSelect.addEventListener('change', function() {
        domaineSelect.innerHTML = '<option value="">-- Sélectionnez --</option>';
        typeSelect.innerHTML = '<option value="">-- Sélectionnez --</option>';
        
        if (this.value && prestationsStructure[this.value]) {
            Object.keys(prestationsStructure[this.value]).forEach(domaine => {
                const opt = document.createElement('option');
                opt.value = domaine;
                opt.textContent = domaine;
                domaineSelect.appendChild(opt);
            });
        }
    });

    domaineSelect.addEventListener('change', function() {
        typeSelect.innerHTML = '<option value="">-- Sélectionnez --</option>';
        
        const theme = themeSelect.value;
        if (theme && this.value && prestationsStructure[theme][this.value]) {
            prestationsStructure[theme][this.value].forEach(type => {
                const opt = document.createElement('option');
                opt.value = type;
                opt.textContent = type;
                typeSelect.appendChild(opt);
            });
        }
    });
    
    // Init pour édition
    if (initialTheme) {
        themeSelect.dispatchEvent(new Event('change'));
        if (initialDomaine) {
            domaineSelect.value = initialDomaine;
            domaineSelect.dispatchEvent(new Event('change'));
            if (initialType) {
                typeSelect.value = initialType;
            }
        }
    }

    // ============================================================================
    // RECHERCHE CLIENT
    // ============================================================================
    const clientSearch = document.getElementById('client_search');
    const clientSuggestions = document.getElementById('client_suggestions');
    const clientIdHidden = document.getElementById('client_id');
    let debounce;

    clientSearch.addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length < 2) {
            clientSuggestions.style.display = 'none';
            return;
        }
        
        clearTimeout(debounce);
        debounce = setTimeout(async () => {
            try {
                const res = await fetch(`/api/rechercher-clients?q=${encodeURIComponent(query)}`);
                const data = await res.json();
                
                if (data.success && data.clients.length > 0) {
                    clientSuggestions.innerHTML = '';
                    data.clients.forEach(client => {
                        const item = document.createElement('button');
                        item.type = 'button';
                        item.className = 'list-group-item list-group-item-action';
                        item.textContent = client.display;
                        item.onclick = () => {
                            clientSearch.value = client.display;
                            clientIdHidden.value = client.id;
                            clientSuggestions.style.display = 'none';
                        };
                        clientSuggestions.appendChild(item);
                    });
                    clientSuggestions.style.display = 'block';
                } else {
                    clientSuggestions.style.display = 'none';
                }
            } catch (error) {
                console.error('Erreur recherche client:', error);
            }
        }, 300);
    });

    // ============================================================================
    // ADRESSE AUTOCOMPLÉTION
    // ============================================================================
    const adresseSearch = document.getElementById('adresse_prestation_search');
    const adresseSuggestions = document.getElementById('adresse_suggestions');
    
    adresseSearch.addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length < 3) {
            adresseSuggestions.style.display = 'none';
            return;
        }
        
        clearTimeout(debounce);
        debounce = setTimeout(async () => {
            try {
                const url = `https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=10`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.features.length > 0) {
                    adresseSuggestions.innerHTML = '';
                    data.features.forEach(feature => {
                        const props = feature.properties;
                        const item = document.createElement('button');
                        item.type = 'button';
                        item.className = 'list-group-item list-group-item-action';
                        item.innerHTML = `<strong>${props.name}</strong><br><small class="text-muted">${props.postcode} ${props.city}</small>`;
                        item.onclick = () => {
                            adresseSearch.value = `${props.name}, ${props.postcode} ${props.city}`;
                            document.getElementById('adresse_prestation').value = props.name;
                            document.getElementById('code_postal_prestation').value = props.postcode;
                            document.getElementById('ville_prestation').value = props.city;
                            adresseSuggestions.style.display = 'none';
                        };
                        adresseSuggestions.appendChild(item);
                    });
                    adresseSuggestions.style.display = 'block';
                }
            } catch (error) {
                console.error('Erreur recherche adresse:', error);
            }
        }, 300);
    });

    // ============================================================================
    // TARIFS DÉTAILLÉS
    // ============================================================================
});

// Fonctions globales tarifs
function ajouterLigneTarif() {
    const container = document.getElementById('tarifs-container');
    const ligne = document.createElement('div');
    ligne.className = 'row mb-2 tarif-item';
    ligne.innerHTML = `
        <div class="col-md-3">
            <input type="text" class="form-control form-control-sm" name="tarif_description[]" placeholder="Description">
        </div>
        <div class="col-md-2">
            <input type="number" step="0.01" class="form-control form-control-sm tarif-qte" name="tarif_quantite[]" placeholder="Qté" value="1">
        </div>
        <div class="col-md-2">
            <input type="number" step="0.01" class="form-control form-control-sm tarif-prix" name="tarif_prix_unitaire[]" placeholder="PU HT">
        </div>
        <div class="col-md-2">
            <input type="number" step="0.01" class="form-control form-control-sm tarif-total" placeholder="Total HT" readonly>
        </div>
        <div class="col-md-2">
            <input type="number" step="0.01" class="form-control form-control-sm" name="tarif_tva[]" placeholder="TVA %" value="20">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.tarif-item').remove(); calculerTotaux();">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    container.appendChild(ligne);
    
    // Attacher événements
    ligne.querySelectorAll('.tarif-qte, .tarif-prix').forEach(input => {
        input.addEventListener('input', function() {
            const row = this.closest('.tarif-item');
            const qte = parseFloat(row.querySelector('.tarif-qte').value) || 0;
            const prix = parseFloat(row.querySelector('.tarif-prix').value) || 0;
            row.querySelector('.tarif-total').value = (qte * prix).toFixed(2);
            calculerTotaux();
        });
    });
    
    ligne.querySelector('[name="tarif_tva[]"]').addEventListener('input', calculerTotaux);
}

function calculerTotaux() {
    let totalHT = 0;
    let totalTVA = 0;
    
    document.querySelectorAll('.tarif-item').forEach(row => {
        const montant = parseFloat(row.querySelector('.tarif-total').value) || 0;
        const tva = parseFloat(row.querySelector('[name="tarif_tva[]"]').value) || 0;
        
        totalHT += montant;
        totalTVA += (montant * tva / 100);
    });
    
    const totalTTC = totalHT + totalTVA;
    
    document.getElementById('total-ht').textContent = totalHT.toFixed(2) + ' €';
    document.getElementById('total-tva').textContent = totalTVA.toFixed(2) + ' €';
    document.getElementById('total-ttc').textContent = totalTTC.toFixed(2) + ' €';
    document.getElementById('tarif_total').value = totalTTC.toFixed(2);
}

// Ajouter une ligne par défaut au chargement
setTimeout(() => {
    ajouterLigneTarif();
}, 100);
</script>
{% endblock %}
