{% extends 'base.html' %}

{% block title %}Configuration Google Calendar{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <!-- En-t√™te -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fab fa-google text-primary"></i> Configuration Google Calendar
                </h2>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Retour
                </a>
            </div>

            <!-- Instructions -->
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle"></i> Comment √ßa marche ?</h5>
                <ol class="mb-0">
                    <li>Assurez-vous que le fichier <code>credentials.json</code> est pr√©sent dans le dossier de l'application</li>
                    <li>Lors de la premi√®re synchronisation, une fen√™tre s'ouvrira pour vous connecter √† votre compte Google</li>
                    <li>Autorisez l'application √† acc√©der √† votre calendrier</li>
                    <li>Choisissez le calendrier o√π les prestations seront synchronis√©es</li>
                </ol>
            </div>

            {% if calendars %}
            <!-- Formulaire de configuration -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-cog"></i> Param√®tres de synchronisation</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <!-- S√©lection du calendrier -->
                        <div class="mb-4">
                            <label for="calendar_id" class="form-label">
                                <strong>Calendrier principal</strong>
                            </label>
                            <select class="form-select" id="calendar_id" name="calendar_id" required>
                                {% for calendar in calendars %}
                                <option value="{{ calendar.id }}"
                                        {% if current_config.get('calendrier_principal', {}).get('id') == calendar.id %}selected{% endif %}>
                                    {{ calendar.summary }}
                                    {% if calendar.primary %}(Principal){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i>
                                Les prestations seront ajout√©es √† ce calendrier
                            </small>
                        </div>

                        <!-- Nom du calendrier (cach√©, synchronis√© avec le select) -->
                        <input type="hidden" id="calendar_name" name="calendar_name" value="">

                        <!-- Option de synchronisation automatique -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="auto_sync" name="auto_sync"
                                       {% if current_config.get('auto_sync') %}checked{% endif %}>
                                <label class="form-check-label" for="auto_sync">
                                    <strong>Synchronisation automatique</strong>
                                </label>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i>
                                Les nouvelles prestations seront automatiquement ajout√©es √† Google Calendar
                            </small>
                        </div>

                        <!-- S√©lection des calendriers √† bloquer -->
                        <div class="mb-4">
                            <label class="form-label">
                                <strong>Calendriers √† bloquer automatiquement</strong>
                            </label>
                            <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                {% for calendar in calendars %}
                                    {% set calendar_blocked = calendar.id in current_config.get('calendriers_a_bloquer_ids', []) %}
                                    {% set is_principal = current_config.get('calendrier_principal', {}).get('id') == calendar.id %}
                                    {% if is_principal %}
                                        {% set input_attrs = 'disabled' %}
                                    {% elif calendar_blocked %}
                                        {% set input_attrs = 'checked' %}
                                    {% else %}
                                        {% set input_attrs = '' %}
                                    {% endif %}

                                    <div class="form-check mb-2">
                                        <input class="form-check-input calendar-bloquer-checkbox" type="checkbox" name="calendriers_a_bloquer" value="{{ calendar.id }}" id="cal_block_{{ loop.index }}" data-calendar-name="{{ calendar.summary }}" {{ input_attrs }}>
                                        <label class="form-check-label" for="cal_block_{{ loop.index }}">
                                            {{ calendar.summary }}
                                            {% if calendar.primary %}
                                                <span class="badge bg-primary">Principal</span>
                                            {% endif %}
                                            {% if is_principal %}
                                                <span class="badge bg-info">Calendrier de destination</span>
                                            {% endif %}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i>
                                Ces calendriers seront marqu√©s comme "üö´ Indisponible" lors de la cr√©ation d'une prestation.
                                <br>
                                <i class="fas fa-lightbulb"></i>
                                Utile pour √©viter les conflits sur vos calendriers personnels ou partag√©s.
                            </small>
                        </div>

                        <!-- Champs cach√©s pour stocker les noms des calendriers -->
                        <input type="hidden" id="calendriers_bloquer_json" name="calendriers_bloquer_json" value="">

                        <!-- Boutons -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Enregistrer la configuration
                            </button>
                            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                                Annuler
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Informations de synchronisation -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-check-circle"></i> Statut de connexion</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-success mb-0">
                        <i class="fas fa-check-circle"></i>
                        <strong>Connect√© √† Google Calendar</strong>
                        <p class="mb-0 mt-2">{{ calendars|length }} calendrier(s) disponible(s)</p>
                    </div>
                </div>
            </div>

            {% else %}
            <!-- Pas de calendriers disponibles -->
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Configuration requise</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <h5><i class="fas fa-exclamation-triangle"></i> Impossible de se connecter √† Google Calendar</h5>
                        <p>Pour utiliser la synchronisation Google Calendar, suivez ces √©tapes :</p>
                        <ol>
                            <li>T√©l√©chargez le fichier <code>credentials.json</code> depuis la <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a></li>
                            <li>Placez-le dans le dossier de l'application (m√™me dossier que app.py)</li>
                            <li>Installez les modules requis :
                                <pre class="mt-2 bg-dark text-white p-2 rounded">pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib</pre>
                            </li>
                            <li>Rechargez cette page</li>
                        </ol>
                    </div>

                    <div class="alert alert-info">
                        <h6><i class="fas fa-book"></i> Besoin d'aide ?</h6>
                        <p class="mb-0">
                            Consultez le fichier <code>INSTALLATION.md</code> dans le dossier de l'application pour un guide d√©taill√©.
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Actions rapides -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-bolt"></i> Actions rapides</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        <form method="POST" action="{{ url_for('gcal_sync_all') }}" style="display: inline;">
                            <button type="submit" class="btn btn-success"
                                    {% if not calendars %}disabled{% endif %}>
                                <i class="fas fa-sync"></i> Synchroniser toutes les prestations
                            </button>
                        </form>

                        <a href="{{ url_for('prestations') }}" class="btn btn-outline-primary">
                            <i class="fas fa-list"></i> Voir les prestations
                        </a>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle"></i>
                        La synchronisation ajoutera toutes les prestations planifi√©es et en cours √† Google Calendar
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Synchroniser le nom du calendrier s√©lectionn√© avec le champ cach√©
    const calendarSelect = document.getElementById('calendar_id');
    const calendarNameInput = document.getElementById('calendar_name');

    if (calendarSelect && calendarNameInput) {
        function updateCalendarName() {
            const selectedOption = calendarSelect.options[calendarSelect.selectedIndex];
            calendarNameInput.value = selectedOption.text;
        }

        updateCalendarName();  // Initialiser
        calendarSelect.addEventListener('change', updateCalendarName);
    }

    // Pr√©parer les donn√©es des calendriers √† bloquer avant soumission
    const form = document.querySelector('form');
    const calendriersBloquerJsonInput = document.getElementById('calendriers_bloquer_json');

    if (form && calendriersBloquerJsonInput) {
        form.addEventListener('submit', function(e) {
            // R√©cup√©rer tous les calendriers coch√©s
            const checkboxes = document.querySelectorAll('.calendar-bloquer-checkbox:checked:not(:disabled)');
            const calendriersABloquer = [];

            checkboxes.forEach(checkbox => {
                calendriersABloquer.push({
                    id: checkbox.value,
                    nom: checkbox.getAttribute('data-calendar-name')
                });
            });

            // Stocker en JSON
            calendriersBloquerJsonInput.value = JSON.stringify(calendriersABloquer);
        });
    }
</script>
{% endblock %}
